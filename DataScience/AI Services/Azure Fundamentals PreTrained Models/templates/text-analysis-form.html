{% extends "base.html" %}
{% block content %}
<style>
    .title {
      text-align: center;
      margin: 20px 0;
    }
    .response-container {
      margin-top: 20px;
    }
    .response-list {
      display: flex;
      justify-content: space-between;
    }
    .response-list div {
      flex: 1;
      margin: 10px;
    }
</style>
<div class="container">
    <h1 class="text-center">Text analysis</h1>

    <!-- Radio Buttons for Options -->
    <div class="form-check">
      <input class="form-check-input" type="radio" name="option" id="fileOption" value="file" checked>
      <label class="form-check-label" for="fileOption">
        Upload Files
      </label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="option" id="textOption" value="text">
      <label class="form-check-label" for="textOption">
        Write Text
      </label>
    </div>

    <!-- File Upload and Text Input Areas -->
    <div id="fileUploadArea" class="mt-3">
      <input type="file" class="form-control-file" id="fileInput">
      <div class="invalid-feedback">Please upload a file.</div>
    </div>
    <div id="textInputArea" class="mt-3" style="display: none;">
      <textarea class="form-control" id="textInput" rows="5" placeholder="Write your text here..."></textarea>
      <div class="invalid-feedback">Please write at least four words.</div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-3">
      <button type="button" class="btn btn-primary" id="submitButton">Submit</button>
      <button type="button" class="btn btn-secondary" id="clearButton">Clear</button>
      <a href="/" class="btn btn-success" id="linkButton">Go to Index</a>
    </div>

    <!-- Server Response Area -->
    <div id="responseContainer" class="response-container">
      <!-- Server response will be displayed here -->
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="loadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <p>Please wait...</p>
        </div>
      </div>
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileOption = document.getElementById('fileOption');
        const textOption = document.getElementById('textOption');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const textInputArea = document.getElementById('textInputArea');
        const fileInput = document.getElementById('fileInput');
        const textInput = document.getElementById('textInput');
        const submitButton = document.getElementById('submitButton');
        const clearButton = document.getElementById('clearButton');
        const responseContainer = document.getElementById('responseContainer');
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

        fileOption.addEventListener('change', () => {
            fileUploadArea.style.display = 'block';
            textInputArea.style.display = 'none';
        });

        textOption.addEventListener('change', () => {
            fileUploadArea.style.display = 'none';
            textInputArea.style.display = 'block';
        });

        const displayServerResponse = (response) => {
            responseContainer.innerHTML = ''; // Clear previous content

            Object.entries(response).forEach(([title, items]) => {
                const listContainer = document.createElement('div');
                const listTitle = document.createElement('h4');
                listTitle.textContent = title;
                const list = document.createElement('ul');
                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = item;
                    list.appendChild(listItem);
                });
                listContainer.appendChild(listTitle);
                listContainer.appendChild(list);
                responseContainer.appendChild(listContainer);
            });
        };

        submitButton.addEventListener('click', () => {
            let isValid = true;
            const formData = new FormData();

            if (fileOption.checked) {
                const files = fileInput.files;
                if (files.length === 0) {
                    fileInput.classList.add('is-invalid');
                    isValid = false;
                } 
                else {
                    fileInput.classList.remove('is-invalid');
                    formData.append('file', files[0]);
                    formData.append('option', 'File');
                }
            } 
            else if (textOption.checked) {
                const text = textInput.value.trim();
                if (text.split(/\s+/).length < 4) {
                    textInput.classList.add('is-invalid');
                    isValid = false;
                } 
                else {
                    textInput.classList.remove('is-invalid');
                    formData.append('text', text);
                    formData.append('option', 'Text');
                }
            }

            if (isValid) {
                loadingModal.show(); // Show the modal
                fetch('/text-analysis', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    loadingModal.hide(); // Hide the modal
                    if (data.error) {
                        alert(data.error);
                    } 
                    else {
                        displayServerResponse(data);
                    }
                })
                .catch(error => {
                    loadingModal.hide(); // Hide the modal
                    console.error('Error:', error);
                });
            }
        });

        clearButton.addEventListener('click', () => {
            fileInput.value = '';
            fileInput.classList.remove('is-invalid');
            textInput.value = '';
            textInput.classList.remove('is-invalid');
            responseContainer.innerHTML = '';
        });
    });
</script>
{% endblock %}